<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Telugu Voice Agent</title>
  <style>
    body {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      font-family: Arial, sans-serif;
      background: #f4f4f4;
    }
    textarea {
      margin-top: 20px;
      width: 80%;
      max-width: 500px;
      padding: 10px;
    }
    .round-btn {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      border: none;
      background: #4CAF50;
      color: white;
      font-size: 20px;
      cursor: pointer;
      box-shadow: 0px 4px 8px rgba(0,0,0,0.2);
      transition: background 0.3s;
    }
    .round-btn:hover {
      background: #45a049;
    }
  </style>
</head>
<body>
  <button class="round-btn" onclick="startListening()">Start</button>
  <textarea id="text" rows="4" cols="50" placeholder="Transcript will appear here..."></textarea>

  <script>
    let recognition;
    let isSpeaking = false;

    function initRecognition() {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SpeechRecognition) {
        alert('Your browser does not support speech recognition');
        return null;
      }

      const rec = new SpeechRecognition();
      rec.lang = 'te-IN';
      rec.interimResults = false;
      rec.maxAlternatives = 1;

      rec.onresult = async (event) => {
        const transcript = event.results[0][0].transcript;
        document.getElementById('text').value = transcript;

        // stop listening before speaking
        rec.stop();

        const reply = await queryGroq(transcript);
        speakText(reply);
      };

      rec.onerror = (event) => {
        console.log("Recognition error:", event.error);
      };

      rec.onend = () => {
        if (!isSpeaking) {
          // restart listening after natural stop
          setTimeout(() => rec.start(), 500);
        }
      };

      return rec;
    }

    function startListening() {
      if (!recognition) {
        recognition = initRecognition();
      }
      recognition.start();
    }

    function speakText(text) {
      isSpeaking = true;
      let utter = new SpeechSynthesisUtterance(text);
      utter.lang = "te-IN";

      utter.onend = () => {
        isSpeaking = false;
        // add small delay before resuming listening
        setTimeout(() => {
          if (recognition) recognition.start();
        }, 800);
      };

      speechSynthesis.speak(utter);
    }

    async function queryGroq(userInput) {
      const resp = await fetch("https://api.groq.com/openai/v1/chat/completions", {
        method: "POST",
        headers: {
          "Authorization": "Bearer", // replace with your key
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          model: "llama3-8b-8192",
          messages: [
            {
              role: "system",
              content: "You are a helpful assistant. The user will always talk in Telugu. Always reply in clear, natural Telugu only. Do not switch to English unless explicitly asked."
            },
            {
              role: "user",
              content: userInput
            }
          ]
        })
      });

      const data = await resp.json();
      return data.choices[0].message.content;
    }
  </script>
</body>
</html>

